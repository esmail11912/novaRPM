<!doctype html>
<html lang="fa">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Metal Finder (Phone Magnetometer)</title>
<style>
  body{font-family:sans-serif;max-width:700px;margin:24px auto;padding:16px}
  .bar{height:14px;background:#eee;border-radius:8px;overflow:hidden}
  .fill{height:100%;width:0%}
  .row{display:flex;gap:12px;align-items:center;margin:12px 0}
  .pill{padding:6px 10px;border-radius:999px;background:#f2f2f2}
  button{padding:10px 14px;border-radius:10px;border:0;background:#111;color:#fff}
  #status{margin-top:10px}
</style>
<h2>Metal Finder (Magnetometer)</h2>
<p>گوشی را آرام حرکت بده و نزدیکِ جسم فلزی کن. اگر میدان از حد بگذرد بوق می‌زند.</p>

<div class="row"><span class="pill">B (µT): <b id="b">0</b></span>
<span class="pill">Threshold: <b id="thv">30</b> µT</span></div>
<div class="bar"><div id="fill" class="fill"></div></div>

<div class="row">
  <button id="perm">Start / اجازه دسترسی</button>
  <input id="th" type="range" min="10" max="150" value="30" step="1">
</div>
<div id="status"></div>

<script>
let audio, osc, running=false, baseline=null, lastBeep=0;

function beep(freq=800, ms=80){
  const now = performance.now();
  if(now-lastBeep < 120) return; // محدودیت بوق
  lastBeep = now;
  if(!audio){ audio = new (window.AudioContext||window.webkitAudioContext)(); }
  const o = audio.createOscillator(), g = audio.createGain();
  o.frequency.value = freq; o.connect(g); g.connect(audio.destination);
  if(osc) osc.stop();
  g.gain.setValueAtTime(0.001, audio.currentTime);
  g.gain.exponentialRampToValueAtTime(0.3, audio.currentTime+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, audio.currentTime + ms/1000);
  o.start(); o.stop(audio.currentTime + ms/1000 + 0.02);
  osc=o;
}

const fill = document.getElementById('fill');
const bEl  = document.getElementById('b');
const th   = document.getElementById('th');
const thv  = document.getElementById('thv');
const status = document.getElementById('status');

th.addEventListener('input', ()=> thv.textContent = th.value);

async function startMagnetometer(){
  thv.textContent = th.value;
  // تلاش برای Generic Sensor API
  if('Magnetometer' in window){
    try{
      const sensor = new Magnetometer({frequency:30});
      sensor.addEventListener('reading', ()=>{
        const B = Math.hypot(sensor.x||0, sensor.y||0, sensor.z||0);
        update(B);
      });
      sensor.addEventListener('error', e=>{
        status.textContent = 'Sensor error: '+ e.error?.message;
      });
      sensor.start();
      status.textContent = 'Magnetometer active.';
      running=true; return;
    }catch(e){ status.textContent = 'Magnetometer API blocked, fallback…'; }
  }
  // fallback با DeviceOrientation (تقریبی)
  if(window.DeviceOrientationEvent){
    try{
      if(typeof DeviceOrientationEvent.requestPermission === 'function'){
        const r = await DeviceOrientationEvent.requestPermission();
        if(r !== 'granted') throw 'no permission';
      }
      window.addEventListener('deviceorientation', ev=>{
        // فقط برای نمایش؛ قدرت واقعی B نمی‌دهد
        const B = Math.abs((ev.alpha||0)-(ev.beta||0)) + Math.abs(ev.gamma||0);
        update(B/5); // مقیاس تقریبی
      });
      status.textContent = 'Fallback orientation running.';
      running=true; return;
    }catch(e){ status.textContent = 'Orientation fallback failed.'; }
  }
  status.textContent = 'سنسور مغناطیس‌سنج در این مرورگر/گوشی در دسترس نیست.';
}

function update(B){
  if(baseline===null){ baseline=B; }        // کالیبره اولیه
  const delta = Math.max(0, B - baseline);  // تغییر نسبت به زمینه
  const t = Number(th.value);
  const pct = Math.min(100, (delta/t)*100);
  fill.style.width = pct + '%';
  fill.style.background = pct>100?'#c00': pct>60?'#f90':'#09f';
  bEl.textContent = B.toFixed(1);
  if(delta > t){ beep(900, 100); }
}

document.getElementById('perm').onclick = async ()=>{
  // برای iOS/Android نیاز به ژست کاربر داریم
  if(!running){ await startMagnetometer(); }
  // تنظیم baseline مجدد با لمس
  baseline = null;
  status.insertAdjacentText('beforeend',' | Baseline set.');
};
</script>
</html>
