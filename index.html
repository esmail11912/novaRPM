<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simple HTML Music Player</title>
<style>
  :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --accent:#22d3ee; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,sans-serif}
  .wrap{max-width:720px;margin:auto;padding:16px}
  .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  h1{font-size:18px;margin:0 0 12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  button,.btn{background:#1f2937;border:none;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  .primary{background:var(--accent);color:#0b1020}
  .controls{display:flex;gap:8px;align-items:center;margin:12px 0}
  .title{font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .meta{opacity:.8;font-size:12px}
  .range{appearance:none;width:100%;height:8px;border-radius:999px;background:#334155;outline:none}
  .time{display:flex;justify-content:space-between;font-size:12px;opacity:.9;margin-top:6px}
  .grid{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;margin-top:12px}
  ul{list-style:none;margin:0;padding:0;max-height:280px;overflow:auto;border:1px solid #1f2937;border-radius:12px}
  li{padding:10px 12px;border-bottom:1px solid #1f2937;display:flex;justify-content:space-between;gap:12px;align-items:center}
  li:last-child{border-bottom:none}
  li.active{background:#0b1224}
  .vol{display:flex;align-items:center;gap:8px}
  input[type="file"]{display:none}
  label.file{background:#0ea5e9;color:#03101a;padding:10px 14px;border-radius:10px;cursor:pointer}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>موزیک‌پلیر ساده (HTML)</h1>

      <div class="row">
        <label class="file">
          انتخاب آهنگ‌ها
          <input id="picker" type="file" accept="audio/*" multiple />
        </label>
        <button id="clear">پاک کردن لیست</button>
      </div>

      <div style="height:12px"></div>

      <div class="grid">
        <div>
          <div class="title" id="trackTitle">آهنگی انتخاب نشده</div>
          <div class="meta" id="trackMeta">—</div>
        </div>
        <div class="vol">
          🔊 <input id="volume" type="range" min="0" max="1" step="0.01" value="1" class="range" style="width:140px">
        </div>
      </div>

      <div class="controls">
        <button id="prev">⏮️</button>
        <button id="play" class="primary">▶️ پخش</button>
        <button id="next">⏭️</button>
        <button id="loop">🔁 Loop: Off</button>
        <button id="shuffle">🔀 Shuffle: Off</button>
      </div>

      <input id="seek" class="range" type="range" min="0" max="1000" value="0">
      <div class="time">
        <span id="curr">00:00</span>
        <span id="dur">00:00</span>
      </div>

      <ul id="list"></ul>

      <!-- پلیر پنهان -->
      <audio id="audio" preload="metadata"></audio>
    </div>
  </div>

<script>
(() => {
  const picker = document.getElementById('picker');
  const clearBtn = document.getElementById('clear');
  const listEl = document.getElementById('list');
  const audio = document.getElementById('audio');

  const titleEl = document.getElementById('trackTitle');
  const metaEl  = document.getElementById('trackMeta');
  const currEl  = document.getElementById('curr');
  const durEl   = document.getElementById('dur');
  const seek    = document.getElementById('seek');
  const volume  = document.getElementById('volume');

  const btnPlay = document.getElementById('play');
  const btnPrev = document.getElementById('prev');
  const btnNext = document.getElementById('next');
  const btnLoop = document.getElementById('loop');
  const btnShuffle = document.getElementById('shuffle');

  /** State */
  let tracks = [];        // {name, url, file}
  let index = -1;
  let isLoop = false;
  let isShuffle = false;
  let seekDrag = false;

  function pad(n){ return String(Math.floor(n)).padStart(2,'0'); }
  function fmt(t){
    if (!isFinite(t)) return '00:00';
    const m = Math.floor(t/60), s = Math.floor(t%60);
    return `${pad(m)}:${pad(s)}`;
  }

  function setActive(i){
    [...listEl.children].forEach((li, idx) => li.classList.toggle('active', idx===i));
  }

  function load(i){
    if (i<0 || i>=tracks.length) return;
    index = i;
    const t = tracks[i];
    audio.src = t.url;
    titleEl.textContent = t.name;
    metaEl.textContent = t.file?.type || 'audio';
    setActive(i);
    audio.play().catch(()=>{}); // ممکنه مرورگر اجازه نده (اول کلیک کنید)
    btnPlay.textContent = '⏸️ توقف';
  }

  function next(auto=false){
    if (isShuffle && tracks.length>1) {
      let r; do { r = Math.floor(Math.random()*tracks.length) } while(r===index);
      load(r); return;
    }
    const n = index+1;
    if (n < tracks.length) load(n);
    else if (isLoop || auto) load(0);
  }
  function prev(){
    const p = index-1;
    if (p >= 0) load(p);
    else if (isLoop && tracks.length) load(tracks.length-1);
  }

  /** Events */
  picker.addEventListener('change', () => {
    // آزاد کردن URLهای قبلی
    tracks.forEach(t => URL.revokeObjectURL(t.url));
    tracks = [...picker.files].map(f => ({
      name: f.name.replace(/\.[^.]+$/,''),
      url: URL.createObjectURL(f),
      file: f
    }));
    renderList();
    if (tracks.length) load(0);
  });

  clearBtn.addEventListener('click', () => {
    tracks.forEach(t => URL.revokeObjectURL(t.url));
    tracks = []; index = -1;
    listEl.innerHTML = '';
    audio.removeAttribute('src');
    titleEl.textContent = 'آهنگی انتخاب نشده';
    metaEl.textContent = '—';
    seek.value = 0; currEl.textContent = '00:00'; durEl.textContent='00:00';
    btnPlay.textContent = '▶️ پخش';
  });

  function renderList(){
    listEl.innerHTML = '';
    tracks.forEach((t,i) => {
      const li = document.createElement('li');
      const left = document.createElement('div');
      left.style.flex = '1';
      left.style.overflow = 'hidden';
      left.style.textOverflow = 'ellipsis';
      left.textContent = t.name;

      const right = document.createElement('div');
      const playBtn = document.createElement('button');
      playBtn.className='btn';
      playBtn.textContent='پخش';
      playBtn.addEventListener('click', e=>{ e.stopPropagation(); load(i); });

      right.appendChild(playBtn);
      li.appendChild(left);
      li.appendChild(right);
      li.addEventListener('click', ()=> load(i));
      listEl.appendChild(li);
    });
    setActive(index);
  }

  btnPlay.addEventListener('click', () => {
    if (!audio.src) return;
    if (audio.paused) { audio.play(); btnPlay.textContent='⏸️ توقف' }
    else { audio.pause(); btnPlay.textContent='▶️ پخش' }
  });
  btnNext.addEventListener('click', next);
  btnPrev.addEventListener('click', prev);

  btnLoop.addEventListener('click', ()=>{
    isLoop = !isLoop;
    btnLoop.textContent = `🔁 Loop: ${isLoop?'On':'Off'}`;
  });
  btnShuffle.addEventListener('click', ()=>{
    isShuffle = !isShuffle;
    btnShuffle.textContent = `🔀 Shuffle: ${isShuffle?'On':'Off'}`;
  });

  audio.addEventListener('timeupdate', () => {
    if (seekDrag) return;
    const p = audio.duration ? (audio.currentTime / audio.duration) : 0;
    seek.value = Math.round(p*1000);
    currEl.textContent = fmt(audio.currentTime);
    durEl.textContent  = fmt(audio.duration || 0);
  });

  seek.addEventListener('input', () => { seekDrag = true; });
  seek.addEventListener('change', () => {
    const p = seek.value/1000;
    if (isFinite(audio.duration)) audio.currentTime = p*audio.duration;
    seekDrag = false;
  });

  volume.addEventListener('input', ()=> audio.volume = +volume.value);

  audio.addEventListener('ended', ()=> next(true));

  // کی‌بوردهای ساده روی دسکتاپ
  window.addEventListener('keydown', (e)=>{
    if (e.code==='Space'){ e.preventDefault(); btnPlay.click(); }
    if (e.key==='ArrowRight') next();
    if (e.key==='ArrowLeft')  prev();
  });

  // Media Session (اختیاری: ممکن است بعضی مرورگرها پشتیبانی نکنند)
  if ('mediaSession' in navigator) {
    navigator.mediaSession.setActionHandler('play', ()=> audio.play());
    navigator.mediaSession.setActionHandler('pause',()=> audio.pause());
    navigator.mediaSession.setActionHandler('previoustrack', prev);
    navigator.mediaSession.setActionHandler('nexttrack', next);
  }
})();
</script>
</body>
</html>
