<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Planner Pro â€” Ø¯ÙØªØ±Ú†Ù‡ + Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²</title>
<style>
:root{
  --bg:#0b0c10;--panel:#121318;--card:#0f1116;--card2:#0d1018;--border:#23273a;--text:#e9edf5;--muted:#a6b1c8;--accent:#7c5cff;--ok:#22c55e;--danger:#ef4444;--warn:#f59e0b;
}
[data-theme="light"]{
  --bg:#f7f7fb;--panel:#ffffff;--card:#ffffff;--card2:#fafafe;--border:#e5e7ef;--text:#0e1320;--muted:#5b647a;--accent:#5b6cff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Ubuntu,"Vazirmatn",Tahoma;color:var(--text);background:var(--bg)}
.app{display:grid;grid-template-columns:270px 1fr;height:100%}
@media(max-width:980px){.app{grid-template-columns:1fr}}
aside{background:var(--panel);border-inline-end:1px solid var(--border);padding:16px;display:flex;flex-direction:column;gap:14px;position:sticky;top:0;height:100vh}
.brand{display:flex;gap:10px;align-items:center}
.logo{width:38px;height:38px;border-radius:12px;background:conic-gradient(from 220deg at 50% 50%,var(--accent),#00e5ff,var(--accent));box-shadow:0 8px 20px rgba(124,92,255,.28)}
.brand h1{font-size:15px;margin:0}
.muted{color:var(--muted);font-size:12px}
nav{display:flex;flex-direction:column;gap:8px}
.tab-btn{border:1px solid var(--border);background:var(--card2);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;text-align:right;display:flex;align-items:center;gap:8px}
.tab-btn.active{background:var(--card);border-color:#2a2e42}
.tools{display:grid;gap:8px}
.btn{border:1px solid var(--border);background:var(--card);color:var(--text);padding:9px 12px;border-radius:12px;cursor:pointer}
.btn.primary{background:var(--accent);border-color:transparent;color:#fff}
.btn.ok{background:var(--ok);border-color:transparent;color:#fff}
.btn.danger{background:var(--danger);border-color:transparent;color:#fff}
.btn.warn{background:var(--warn);border-color:transparent;color:#fff}
.btn.small{padding:6px 10px;font-size:12px}
main{overflow:auto;padding:18px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
input,select,textarea{background:color-mix(in oklab, var(--card) 80%, #000 20%);border:1px solid var(--border);color:var(--text);border-radius:12px;padding:10px}
textarea{min-height:140px;resize:vertical}
.header{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.spacer{flex:1}
.list{display:flex;flex-direction:column;gap:8px}
.note-item{display:flex;flex-direction:column;gap:6px;border:1px solid var(--border);border-radius:12px;padding:10px}
.note-head{display:flex;align-items:center;gap:8px}
.note-head input{font-weight:700;flex:1}
.kbd{font-family:ui-monospace,Menlo,monospace;font-size:11px;background:color-mix(in oklab, var(--card) 80%, #000 20%);border:1px solid var(--border);border-radius:6px;padding:2px 6px}
/* calendar */
.cal-wrap{user-select:none}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px}
.cal-week{font-size:12px;color:var(--muted);text-align:center}
.cal-cell{border:1px solid var(--border);border-radius:12px;min-height:84px;padding:8px;background:linear-gradient(180deg,var(--card),color-mix(in oklab, var(--card) 70%, #000 30%));position:relative}
.cal-cell.today{outline:2px solid var(--accent)}
.cal-cell .d{font-size:12px;color:var(--muted)}
.cal-cell .badge{position:absolute;bottom:8px;left:8px;font-size:10px;border:1px solid var(--border);padding:0 6px;border-radius:999px;background:color-mix(in oklab, var(--card) 80%, #000 20%)}
.task{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;border:1px solid var(--border);border-radius:12px;padding:8px}
.task.done{opacity:.6;text-decoration:line-through}
.grid{display:grid;gap:14px}
.grid-2{grid-template-columns:360px 1fr}
@media(max-width:1100px){.grid-2{grid-template-columns:1fr}}
.footer{margin-top:6px;color:var(--muted);font-size:12px}
/* topbar */
.topbar{position:sticky;top:0;z-index:5;background:color-mix(in oklab, var(--panel) 92%, #000 8%);border-bottom:1px solid var(--border);padding:10px 16px;display:flex;align-items:center;gap:10px}
.topbar .pill{border:1px dashed var(--border);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="app" id="appRoot">
  <aside>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Planner Pro</h1>
        <div class="muted">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª + Ø±ÙˆØ²Ø§Ù†Ù‡ + Ù…Ø§Ù‡Ø§Ù†Ù‡ + Ø³Ø§Ù„Ø§Ù†Ù‡</div>
      </div>
    </div>
    <nav>
      <button class="tab-btn active" data-tab="notes">ğŸ“ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§</button>
      <button class="tab-btn" data-tab="daily">ğŸ—“ï¸ Ø±ÙˆØ²Ø§Ù†Ù‡</button>
      <button class="tab-btn" data-tab="monthly">ğŸ“… Ù…Ø§Ù‡Ø§Ù†Ù‡</button>
      <button class="tab-btn" data-tab="yearly">ğŸ“† Ø³Ø§Ù„Ø§Ù†Ù‡</button>
      <button class="tab-btn" data-tab="calendar">ğŸ“š ØªÙ‚ÙˆÛŒÙ…</button>
      <button class="tab-btn" data-tab="settings">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
    </nav>
    <div class="tools">
      <button id="exportBtn" class="btn">ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ JSON</button>
      <label class="btn" style="display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer">ğŸ“¥ ÙˆØ±ÙˆØ¯ JSON
        <input id="importFile" type="file" accept="application/json" style="display:none">
      </label>
      <button id="clearAll" class="btn danger">ğŸ§¹ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ù‡Ù…Ù‡</button>
    </div>
    <div class="footer">Ù…ÛŒØ§Ù†Ø¨Ø±Ù‡Ø§: <span class="kbd">Ctrl/Cmd + S</span> Ø°Ø®ÛŒØ±Ù‡ | <span class="kbd">N</span> ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø¬Ø¯ÛŒØ¯</div>
  </aside>

  <main>
    <div class="topbar">
      <div id="pathCrumb" class="pill">Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ø³Ø±ÛŒØ¹ â€¢ Ø±ÙˆÛŒ Ù‡Ø± Ú¯Ø²ÛŒÙ†Ù‡ Ú©Ù‡ Ø¨Ø²Ù†ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ù‡Ù…Ø§Ù† ØµÙØ­Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯</div>
      <div class="spacer"></div>
      <button id="printBtn" class="btn small">ğŸ–¨ï¸ Ú†Ø§Ù¾</button>
      <button id="todayBtn" class="btn small">Ø§Ù…Ø±ÙˆØ²</button>
    </div>

    <!-- Notes -->
    <section id="tab-notes">
      <div class="header">
        <h2>ğŸ“ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§</h2>
        <div class="spacer"></div>
        <input id="searchNotes" placeholder="Ø¬Ø³ØªØ¬Ùˆâ€¦" />
        <button id="newNote" class="btn primary">â• ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø¬Ø¯ÛŒØ¯</button>
      </div>
      <div class="grid grid-2" style="margin-top:12px;">
        <div class="card">
          <div class="list" id="notesList"></div>
        </div>
        <div class="card">
          <div class="grid">
            <input id="noteTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† ÛŒØ§Ø¯Ø¯Ø§Ø´Øª" />
            <textarea id="noteBody" placeholder="Ù…ØªÙ† ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€¦"></textarea>
            <div style="display:flex;gap:8px;align-items:center;">
              <input id="noteTags" placeholder="Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ (Ø¨Ø§ , Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯)" />
              <div class="spacer"></div>
              <button id="saveNote" class="btn ok">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
              <button id="deleteNote" class="btn danger">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Daily -->
    <section id="tab-daily" hidden>
      <div class="header">
        <h2>ğŸ—“ï¸ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡</h2>
        <div class="spacer"></div>
        <input type="date" id="dailyDate" />
        <button id="addDailyTask" class="btn primary">â• Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯</button>
      </div>
      <div class="grid grid-2" style="margin-top:12px;">
        <div class="card">
          <h3 style="margin:0 0 8px 0">ÙÙ‡Ø±Ø³Øª Ú©Ø§Ø±Ù‡Ø§</h3>
          <div id="dailyList" class="list"></div>
        </div>
        <div class="card">
          <h3 style="margin:0 0 8px 0">Ø®Ù„Ø§ØµÙ‡ Ø±ÙˆØ²</h3>
          <div id="dailySummary" class="list"></div>
          <div id="dailyStats" class="footer"></div>
        </div>
      </div>
    </section>

    <!-- Monthly -->
    <section id="tab-monthly" hidden>
      <div class="header">
        <h2>ğŸ“… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø§Ù‡Ø§Ù†Ù‡</h2>
        <div class="spacer"></div>
        <input type="month" id="monthPicker" />
        <button id="addMonthlyGoal" class="btn primary">â• Ù‡Ø¯Ù/Ú©Ø§Ø±</button>
      </div>
      <div class="grid grid-2" style="margin-top:12px;">
        <div class="card">
          <h3 style="margin:0 0 8px 0">Ø§Ù‡Ø¯Ø§Ù Ùˆ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ù…Ø§Ù‡</h3>
          <div id="monthlyList" class="list"></div>
        </div>
        <div class="card">
          <h3 style="margin:0 0 8px 0">ØªÙ‚Ø³ÛŒÙ…â€ŒØ¨Ù†Ø¯ÛŒ Ù‡ÙØªÚ¯ÛŒ</h3>
          <div id="weeklyBreakdown" class="list"></div>
        </div>
      </div>
    </section>

    <!-- Yearly -->
    <section id="tab-yearly" hidden>
      <div class="header">
        <h2>ğŸ“† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø³Ø§Ù„Ø§Ù†Ù‡</h2>
        <div class="spacer"></div>
        <input type="number" id="yearPicker" min="1970" max="2999" step="1" style="width:110px" />
        <button id="addYearlyGoal" class="btn primary">â• Ù‡Ø¯Ù/Ù†Ù‚Ø·Ù‡â€ŒØ¹Ø·Ù</button>
      </div>
      <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px;">
        <div class="card"><h3 style="margin:0 0 6px 0">Ø±Ø¨Ø¹ Û±</h3><div id="q1" class="list"></div></div>
        <div class="card"><h3 style="margin:0 0 6px 0">Ø±Ø¨Ø¹ Û²</h3><div id="q2" class="list"></div></div>
        <div class="card"><h3 style="margin:0 0 6px 0">Ø±Ø¨Ø¹ Û³</h3><div id="q3" class="list"></div></div>
        <div class="card"><h3 style="margin:0 0 6px 0">Ø±Ø¨Ø¹ Û´</h3><div id="q4" class="list"></div></div>
      </div>
    </section>

    <!-- Calendar -->
    <section id="tab-calendar" hidden>
      <div class="header">
        <h2>ğŸ“š ØªÙ‚ÙˆÛŒÙ…</h2>
        <div class="spacer"></div>
        <button id="prevMonth" class="btn small">â—€ï¸</button>
        <div id="calMonthLabel" class="muted"></div>
        <button id="nextMonth" class="btn small">â–¶ï¸</button>
      </div>
      <div class="cal-wrap card" style="margin-top:12px;">
        <div class="cal-grid" id="weekdayRow"></div>
        <div class="cal-grid" id="daysGrid"></div>
      </div>
      <div class="footer">Ø±ÙˆÛŒ Ù‡Ø± Ø±ÙˆØ² Ø¨Ø²Ù†ÛŒØ¯ ØªØ§ Ù…Ø³ØªÙ‚ÛŒÙ… ÙˆØ§Ø±Ø¯ Â«Ø±ÙˆØ²Ø§Ù†Ù‡Â» Ù‡Ù…Ø§Ù† ØªØ§Ø±ÛŒØ® Ø´ÙˆÛŒØ¯.</div>
    </section>

    <!-- Settings -->
    <section id="tab-settings" hidden>
      <div class="header"><h2>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2></div>
      <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">
        <div class="card">
          <h3 style="margin-top:0">ØªÙ‚ÙˆÛŒÙ…</h3>
          <label>Ù†ÙˆØ¹ ØªÙ‚ÙˆÛŒÙ…
            <select id="calendarType" style="width:100%;margin-top:6px">
              <option value="gregorian">Ù…ÛŒÙ„Ø§Ø¯ÛŒ (Gregorian)</option>
              <option value="persian">Ø´Ù…Ø³ÛŒ / Ø®ÙˆØ±Ø´ÛŒØ¯ÛŒ (Persian)</option>
              <option value="islamic">Ù‚Ù…Ø±ÛŒ (Hijri)</option>
            </select>
          </label>
          <label style="display:block; margin-top:10px;">Ø§ÙˆÙ„ÛŒÙ† Ø±ÙˆØ² Ù‡ÙØªÙ‡
            <select id="firstDay" style="width:100%;margin-top:6px">
              <option value="6">Ø´Ù†Ø¨Ù‡</option>
              <option value="0">ÛŒÚ©Ø´Ù†Ø¨Ù‡</option>
              <option value="1">Ø¯ÙˆØ´Ù†Ø¨Ù‡</option>
            </select>
          </label>
        </div>
        <div class="card">
          <h3 style="margin-top:0">Ø¸Ø§Ù‡Ø± Ùˆ Ø´Ø±ÙˆØ¹</h3>
          <label>Ù¾ÙˆØ³ØªÙ‡
            <select id="themePicker" style="width:100%;margin-top:6px">
              <option value="dark">ØªÛŒØ±Ù‡</option>
              <option value="light">Ø±ÙˆØ´Ù†</option>
            </select>
          </label>
          <label style="display:block; margin-top:10px;">ØµÙØ­Ù‡ Ø´Ø±ÙˆØ¹
            <select id="startTab" style="width:100%;margin-top:6px">
              <option value="notes">ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§</option>
              <option value="daily">Ø±ÙˆØ²Ø§Ù†Ù‡</option>
              <option value="monthly">Ù…Ø§Ù‡Ø§Ù†Ù‡</option>
              <option value="yearly">Ø³Ø§Ù„Ø§Ù†Ù‡</option>
              <option value="calendar">ØªÙ‚ÙˆÛŒÙ…</option>
              <option value="settings">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</option>
            </select>
          </label>
          <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
            <button id="applySettings" class="btn ok">Ø§Ø¹Ù…Ø§Ù„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
            <button id="resetSettings" class="btn warn">Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ</button>
          </div>
        </div>
      </div>
      <div class="footer" style="margin-top:10px">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¯Ø± APK Ù‡Ù… Ø¢ÙÙ„Ø§ÛŒÙ† Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</div>
    </section>
  </main>
</div>

<template id="taskTemplate">
  <div class="task">
    <input type="checkbox" class="t-done"/>
    <div>
      <div style="display:flex;gap:8px;align-items:center;">
        <input class="t-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ú©Ø§Ø±" style="width:100%"/>
        <select class="t-priority">
          <option value="low">Ú©Ù…</option>
          <option value="med">Ù…ØªÙˆØ³Ø·</option>
          <option value="high">Ø²ÛŒØ§Ø¯</option>
          <option value="urgent">ÙÙˆØ±ÛŒ</option>
        </select>
        <input type="time" class="t-time"/>
        <input type="date" class="t-date"/>
      </div>
      <textarea class="t-notes" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€¦" style="margin-top:6px"></textarea>
      <div class="footer"><span class="t-chip"></span></div>
    </div>
    <button class="btn small danger t-del">âœ–</button>
  </div>
</template>

<script>
// ====== Storage & Settings
const DB_KEY = 'plannerPro.v2';
const SET_KEY = 'plannerPro.settings.v2';
const blank = { notes: [], daily: {}, monthly: {}, yearly: {} };
const defaultSettings = { calendar:'persian', firstDay:6, theme:'dark', startTab:'daily' };
let db = load();
let settings = loadSettings();
applyTheme(settings.theme);

function save(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
function load(){ try{ return JSON.parse(localStorage.getItem(DB_KEY)) || structuredClone(blank);}catch{ return structuredClone(blank);} }
function saveSettings(){ localStorage.setItem(SET_KEY, JSON.stringify(settings)); }
function loadSettings(){ try{ return JSON.parse(localStorage.getItem(SET_KEY)) || {...defaultSettings}; }catch{ return {...defaultSettings}; } }
function uid(){ return Math.random().toString(36).slice(2,9); }

// ====== Helpers
const $ = (q)=>document.querySelector(q);
const $$ = (q)=>Array.from(document.querySelectorAll(q));
function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function addMonths(d, n){ const x=new Date(d); x.setMonth(x.getMonth()+n); return x; }
function sameDay(a,b){ return a.getFullYear()==b.getFullYear() && a.getMonth()==b.getMonth() && a.getDate()==b.getDate(); }
function toISODate(d){ return new Date(d).toISOString().slice(0,10); }

// Intl formatters (multi-calendar)
function calLocale(calendar){
  if(calendar==='persian') return 'fa-IR-u-ca-persian';
  if(calendar==='islamic') return 'fa-IR-u-ca-islamic';
  return 'fa-IR-u-ca-gregory';
}
function fmtDay(date, calendar){
  const f = new Intl.DateTimeFormat(calLocale(calendar), { day:'numeric' });
  return Number(f.format(date));
}
function fmtMonthNum(date, calendar){
  const f = new Intl.DateTimeFormat(calLocale(calendar), { month:'numeric' });
  return Number(f.format(date));
}
function fmtMonthLabel(date, calendar){
  const f = new Intl.DateTimeFormat(calLocale(calendar), { month:'long', year:'numeric' });
  return f.format(date);
}
// find first visible day (day=1 in chosen calendar)
function monthStart(date, calendar){
  let d = new Date(date);
  for(let i=0;i<45;i++){
    if(fmtDay(d, calendar)===1) break;
    d = addDays(d, -1);
  }
  return d;
}
function monthCells(date, calendar){
  const start = monthStart(date, calendar);
  const monthId = fmtMonthNum(start, calendar) + '-' + new Intl.DateTimeFormat(calLocale(calendar), { year:'numeric' }).format(start);
  const cells = [];
  let d = new Date(start);
  for(let i=0;i<40;i++){
    if(i>0 && fmtDay(d, calendar)===1 && (fmtMonthNum(d, calendar) + '-' + new Intl.DateTimeFormat(calLocale(calendar), { year:'numeric' }).format(d)) !== monthId) break;
    cells.push(new Date(d));
    d = addDays(d, 1);
  }
  return { start, cells };
}

// ====== Tabs & Path
const sections={
  notes: $('#tab-notes'),
  daily: $('#tab-daily'),
  monthly: $('#tab-monthly'),
  yearly: $('#tab-yearly'),
  calendar: $('#tab-calendar'),
  settings: $('#tab-settings')
};
function activateTab(id){
  $$('.tab-btn').forEach(x=>x.classList.remove('active'));
  document.querySelector(`.tab-btn[data-tab="${id}"]`)?.classList.add('active');
  Object.values(sections).forEach(s=>s.hidden=true);
  sections[id].hidden=false;
  $('#pathCrumb').textContent = 'Ø¯Ø±: ' + {
    notes:'ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§', daily:'Ø±ÙˆØ²Ø§Ù†Ù‡', monthly:'Ù…Ø§Ù‡Ø§Ù†Ù‡', yearly:'Ø³Ø§Ù„Ø§Ù†Ù‡', calendar:'ØªÙ‚ÙˆÛŒÙ…', settings:'ØªÙ†Ø¸ÛŒÙ…Ø§Øª'
  }[id];
  if(id==='calendar') renderCalendar();
}
// Ø§ØªØµØ§Ù„ Ù…Ù†Ùˆ Ø¨Ù‡ ØªØ¨â€ŒÙ‡Ø§ (ÙÛŒÚ©Ø³Ù Â«Ø±ÙˆÛŒ Ú¯Ø²ÛŒÙ†Ù‡ Ù…ÛŒâ€ŒØ²Ù†Ù… Ù†Ù…ÛŒâ€ŒØ±Ù‡Â»)
$$('.tab-btn').forEach(b=> b.addEventListener('click', ()=> activateTab(b.dataset.tab)));

// ====== Notes
const notesList = $('#notesList');
const searchNotes = $('#searchNotes');
const noteTitle = $('#noteTitle');
const noteBody  = $('#noteBody');
const noteTags  = $('#noteTags');
const newNoteBtn= $('#newNote');
const saveNoteBtn= $('#saveNote');
const deleteNoteBtn= $('#deleteNote');
let activeNoteId = null;

function renderNotes(){
  const q = (searchNotes.value||'').trim().toLowerCase();
  const items = db.notes.slice()
    .sort((a,b)=> (b.pinned===a.pinned ? b.updatedAt - a.updatedAt : (b.pinned?1:-1)))
    .filter(n => !q || (n.title||'').toLowerCase().includes(q) || (n.body||'').toLowerCase().includes(q) || (Array.isArray(n.tags)&&n.tags.join(',').toLowerCase().includes(q)));
  notesList.innerHTML='';
  if(items.length===0){ notesList.innerHTML = '<div class="muted">ÛŒØ§Ø¯Ø¯Ø§Ø´ØªÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.</div>'; return; }
  for(const n of items){
    const el = document.createElement('div');
    el.className='note-item';
    el.innerHTML = `
      <div class="note-head">
        <input value="${(n.title||'').replace(/"/g,'&quot;')}" placeholder="Ø¹Ù†ÙˆØ§Ù†" data-id="${n.id}" class="n-title" />
        <button class="btn small" data-pin="${n.id}">${n.pinned?'ğŸ“Œ':'ğŸ“'}</button>
        <button class="btn small danger" data-del="${n.id}">Ø­Ø°Ù</button>
      </div>
      <div class="muted" style="font-size:11px">${new Date(n.updatedAt).toLocaleString('fa-IR')}</div>
    `;
    el.addEventListener('click',()=>{ loadNoteToEditor(n.id); activateTab('notes'); });
    notesList.appendChild(el);
  }
}
function loadNoteToEditor(id){
  const n = db.notes.find(x=>x.id===id); if(!n) return;
  activeNoteId = id; noteTitle.value = n.title||''; noteBody.value = n.body||''; noteTags.value = (n.tags||[]).join(', ');
}
function upsertActiveNote(){
  const payload = { title: noteTitle.value.trim(), body: noteBody.value.trim(), tags: noteTags.value.split(',').map(s=>s.trim()).filter(Boolean) };
  if(!activeNoteId){ const n = { id: uid(), ...payload, pinned:false, createdAt:Date.now(), updatedAt:Date.now() }; db.notes.unshift(n); activeNoteId = n.id; }
  else{ const i = db.notes.findIndex(n=>n.id===activeNoteId); if(i>-1){ db.notes[i] = { ...db.notes[i], ...payload, updatedAt:Date.now() }; } }
  save(); renderNotes();
}
function deleteActiveNote(){ if(!activeNoteId) return; db.notes = db.notes.filter(n=>n.id!==activeNoteId); activeNoteId=null; noteTitle.value=''; noteBody.value=''; noteTags.value=''; save(); renderNotes(); }

newNoteBtn.addEventListener('click', ()=>{ activeNoteId=null; noteTitle.value=''; noteBody.value=''; noteTags.value=''; });
saveNoteBtn.addEventListener('click', upsertActiveNote);
deleteNoteBtn.addEventListener('click', deleteActiveNote);
searchNotes.addEventListener('input', renderNotes);
notesList.addEventListener('input', (e)=>{
  const id = e.target.dataset.id;
  if(e.target.classList.contains('n-title')){
    const n = db.notes.find(x=>x.id===id); if(n){ n.title = e.target.value; n.updatedAt=Date.now(); save(); }
  }
});
notesList.addEventListener('click', (e)=>{
  const idPin = e.target.dataset.pin; const idDel = e.target.dataset.del;
  if(idPin){ const n = db.notes.find(x=>x.id===idPin); if(n){ n.pinned=!n.pinned; n.updatedAt=Date.now(); save(); renderNotes(); } }
  if(idDel){ if(confirm('Ø­Ø°Ù Ø§ÛŒÙ† ÛŒØ§Ø¯Ø¯Ø§Ø´ØªØŸ')){ db.notes = db.notes.filter(n=>n.id!==idDel); save(); renderNotes(); } }
});
document.addEventListener('keydown', (e)=>{
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); upsertActiveNote(); }
  if(!e.ctrlKey && !e.metaKey && e.key.toLowerCase()==='n'){ newNoteBtn.click(); }
});
renderNotes();

// ====== Daily Planner
const dailyDate = $('#dailyDate');
const dailyList = $('#dailyList');
const dailySummary = $('#dailySummary');
const dailyStats = $('#dailyStats');
const addDailyTask = $('#addDailyTask');

function ensureDay(dateStr){ if(!db.daily[dateStr]) db.daily[dateStr]=[]; }
function renderDaily(){
  const key = dailyDate.value || toISODate(new Date()); ensureDay(key);
  const items = db.daily[key]; dailyList.innerHTML=''; let done=0;
  for(const t of items){
    const $tpl = document.querySelector('#taskTemplate');
    const el = $tpl.content.firstElementChild.cloneNode(true);
    el.querySelector('.t-done').checked = !!t.done; if(t.done) el.classList.add('done');
    el.querySelector('.t-title').value = t.title||'';
    el.querySelector('.t-priority').value = t.priority||'med';
    el.querySelector('.t-time').value = t.time||'';
    el.querySelector('.t-date').value = t.date||key;
    el.querySelector('.t-notes').value = t.notes||'';
    el.querySelector('.t-chip').textContent = 'Ø§ÙˆÙ„ÙˆÛŒØª: ' + (t.priority||'med');
    el.querySelector('.t-done').addEventListener('change', (e)=>{ t.done = e.target.checked; save(); renderDaily(); });
    el.querySelector('.t-del').addEventListener('click', ()=>{ db.daily[key] = db.daily[key].filter(x=>x.id!==t.id); save(); renderDaily(); });
    el.querySelectorAll('input,select,textarea').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        t.title = el.querySelector('.t-title').value;
        t.priority = el.querySelector('.t-priority').value;
        t.time = el.querySelector('.t-time').value;
        t.date = el.querySelector('.t-date').value;
        t.notes = el.querySelector('.t-notes').value;
        save();
      });
    });
    dailyList.appendChild(el);
    if(t.done) done++;
  }
  dailySummary.innerHTML = items.slice(0,3).map(t=>`â€¢ ${t.title||'â€”'}`).join('<br>') || '<span class="muted">Ø®Ù„Ø§ØµÙ‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</span>';
  dailyStats.textContent = `Ù…Ø¬Ù…ÙˆØ¹: ${items.length} â€” Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡: ${done} â€” Ø¨Ø§Ù‚ÛŒ: ${items.length-done}`;
}
dailyDate.value = toISODate(new Date());
addDailyTask.addEventListener('click', ()=>{ const key = dailyDate.value; ensureDay(key); db.daily[key].push({ id: uid(), title:'Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯', priority:'med', time:'', date:key, notes:'', done:false }); save(); renderDaily(); });
dailyDate.addEventListener('change', renderDaily);
renderDaily();

// ====== Monthly
const monthPicker = $('#monthPicker');
const monthlyList = $('#monthlyList');
const weeklyBreakdown = $('#weeklyBreakdown');
const addMonthlyGoal = $('#addMonthlyGoal');
monthPicker.value = toISODate(new Date()).slice(0,7);

function renderMonthly(){
  const key = monthPicker.value;
  const arr = db.monthly[key] || [];
  monthlyList.innerHTML='';
  if(arr.length===0) monthlyList.innerHTML='<div class="muted">Ù…ÙˆØ±Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</div>';
  arr.forEach((it,idx)=>{
    const row = document.createElement('div'); row.className='note-item';
    row.innerHTML = `
      <div class="note-head">
        <input value="${(it.title||'').replace(/"/g,'&quot;')}" placeholder="Ù‡Ø¯Ù/Ú©Ø§Ø± Ù…Ø§Ù‡Ø§Ù†Ù‡" data-idx="${idx}" class="m-title" />
        <button class="btn small danger" data-del="${idx}">Ø­Ø°Ù</button>
      </div>
      <textarea class="m-notes" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øªâ€¦">${(it.notes||'')}</textarea>
    `;
    row.addEventListener('click',()=>{ activateTab('monthly'); });
    monthlyList.appendChild(row);
  });
  // Breakdown Ø³Ø§Ø¯Ù‡ Ø§Ø² Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡
  weeklyBreakdown.innerHTML = '';
  const weeks = [0,0,0,0,0,0];
  const mStart = new Date(key+'-01T00:00:00');
  const mEnd = new Date(mStart.getFullYear(), mStart.getMonth()+1, 0);
  for(let d=new Date(mStart); d<=mEnd; d=addDays(d,1)){
    const wIndex = Math.floor((d.getDate()-1)/7);
    const dayKey = toISODate(d);
    weeks[wIndex] += (db.daily[dayKey]||[]).length;
  }
  weeks.forEach((cnt,i)=>{ const item = document.createElement('div'); item.textContent = `Ù‡ÙØªÙ‡ ${i+1}: ${cnt} Ú©Ø§Ø± Ø±ÙˆØ²Ø§Ù†Ù‡`; weeklyBreakdown.appendChild(item); });
}
addMonthlyGoal.addEventListener('click', ()=>{ const key = monthPicker.value; if(!db.monthly[key]) db.monthly[key]=[]; db.monthly[key].push({ title:'Ù‡Ø¯Ù Ø¬Ø¯ÛŒØ¯', notes:'' }); save(); renderMonthly(); });
monthPicker.addEventListener('change', renderMonthly);
monthlyList.addEventListener('input',(e)=>{
  const key = monthPicker.value; const idx = +e.target.dataset.idx;
  if(e.target.classList.contains('m-title')){ db.monthly[key][idx].title = e.target.value; }
  else if(e.target.classList.contains('m-notes')){ db.monthly[key][idx].notes = e.target.value; }
  save();
});
monthlyList.addEventListener('click',(e)=>{
  const key = monthPicker.value; const idx = +e.target.dataset.del;
  if(Number.isInteger(idx)){ db.monthly[key].splice(idx,1); save(); renderMonthly(); }
});
renderMonthly();

// ====== Yearly
const yearPicker = $('#yearPicker');
const addYearlyGoal = $('#addYearlyGoal');
yearPicker.value = String(new Date().getFullYear());
function renderQuarter(qId){
  const list = $('#'+qId); const arr = db.yearly[qId] || [];
  list.innerHTML='';
  arr.forEach((it,idx)=>{
    const row = document.createElement('div');
    row.className='note-item';
    row.innerHTML = `
      <div class="note-head">
        <input value="${(it.title||'').replace(/"/g,'&quot;')}" placeholder="Ù‡Ø¯Ù/Ù†Ù‚Ø·Ù‡â€ŒØ¹Ø·Ù" data-idx="${idx}" data-q="${qId}" class="y-title" />
        <button class="btn small danger" data-del="${idx}" data-q="${qId}">Ø­Ø°Ù</button>
      </div>
      <textarea class="y-notes" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øªâ€¦">${(it.notes||'')}</textarea>
    `;
    row.addEventListener('click',()=>{ activateTab('yearly'); });
    list.appendChild(row);
  });
}
function renderYearly(){ ['q1','q2','q3','q4'].forEach(renderQuarter); }
addYearlyGoal.addEventListener('click', ()=>{
  const qId = prompt('Ú©Ø¯Ø§Ù… Ø±Ø¨Ø¹ØŸ (q1/q2/q3/q4)','q1');
  if(!qId || !['q1','q2','q3','q4'].includes(qId)) return;
  if(!db.yearly[qId]) db.yearly[qId]=[];
  db.yearly[qId].push({ title:'Ù‡Ø¯Ù Ø¬Ø¯ÛŒØ¯', notes:'' });
  save(); renderYearly();
});
document.addEventListener('input', (e)=>{
  if(e.target.classList.contains('y-title')){
    const q = e.target.dataset.q; const i = +e.target.dataset.idx;
    db.yearly[q][i].title = e.target.value; save();
  }
  if(e.target.classList.contains('y-notes')){ save(); }
});
document.addEventListener('click', (e)=>{
  if(e.target.dataset?.q && e.target.dataset?.del){
    const q = e.target.dataset.q; const i = +e.target.dataset.del;
    db.yearly[q].splice(i,1); save(); renderYearly();
  }
});
renderYearly();

// ====== Calendar (multi-calendar)
const weekdayRow = $('#weekdayRow');
const daysGrid = $('#daysGrid');
const calMonthLabel = $('#calMonthLabel');
const prevMonthBtn = $('#prevMonth');
const nextMonthBtn = $('#nextMonth');
let calView = new Date();

function weekdayNames(first){ // 6=Sat,0=Sun,1=Mon
  const base = ['Ø´','ÛŒ','Ø¯','Ø³','Ú†','Ù¾','Ø¬']; // Sat..Fri
  const order = [0,1,2,3,4,5,6];
  const shift = first===6?0:(first===0?1:2);
  return order.map((_,i)=> base[(i+shift)%7]);
}
function renderCalendar(){
  weekdayRow.innerHTML='';
  weekdayNames(settings.firstDay).forEach(w=>{ const d = document.createElement('div'); d.className='cal-week'; d.textContent=w; weekdayRow.appendChild(d); });
  daysGrid.innerHTML='';
  calMonthLabel.textContent = fmtMonthLabel(calView, settings.calendar);
  const { start, cells } = monthCells(calView, settings.calendar);
  const jsStartDay = start.getDay();
  const leading = ( (jsStartDay - settings.firstDay + 7) % 7 );
  for(let i=0;i<leading;i++){ const ph = document.createElement('div'); ph.className='cal-cell'; ph.style.visibility='hidden'; daysGrid.appendChild(ph); }
  const today = new Date();
  for(const d of cells){
    const el = document.createElement('div'); el.className='cal-cell'+(sameDay(d,today)?' today':'');
    el.innerHTML = '<div class="d">'+ fmtDay(d, settings.calendar) +'</div>';
    const k = toISODate(d);
    const cnt = (db.daily[k]||[]).length;
    if(cnt>0){ const b=document.createElement('div'); b.className='badge'; b.textContent=cnt+' Ú©Ø§Ø±'; el.appendChild(b); }
    el.title = new Intl.DateTimeFormat(calLocale(settings.calendar), { dateStyle:'full' }).format(d) + (cnt? ` â€” ${cnt} Ú©Ø§Ø±`:'');
    el.addEventListener('click', ()=>{ activateTab('daily'); dailyDate.value = k; renderDaily(); });
    daysGrid.appendChild(el);
  }
}
prevMonthBtn.addEventListener('click', ()=>{ calView = addMonths(calView,-1); renderCalendar(); });
nextMonthBtn.addEventListener('click', ()=>{ calView = addMonths(calView, 1); renderCalendar(); });

// ====== Settings UI
const calendarType = $('#calendarType');
const firstDay = $('#firstDay');
const themePicker = $('#themePicker');
const startTab = $('#startTab');
const applySettingsBtn = $('#applySettings');
const resetSettingsBtn = $('#resetSettings');

function hydrateSettingsUI(){
  calendarType.value = settings.calendar;
  firstDay.value = String(settings.firstDay);
  themePicker.value = settings.theme;
  startTab.value = settings.startTab;
  document.documentElement.setAttribute('data-theme', settings.theme);
}
function applyTheme(theme){ document.documentElement.setAttribute('data-theme', theme); }

document.getElementById('todayBtn').addEventListener('click', ()=>{ calView = new Date(); dailyDate.value = toISODate(new Date()); renderDaily(); renderCalendar(); });
document.getElementById('printBtn').addEventListener('click', ()=>{ window.print(); });

applySettingsBtn.addEventListener('click', ()=>{
  settings.calendar = calendarType.value;
  settings.firstDay = Number(firstDay.value);
  settings.theme = themePicker.value;
  settings.startTab = startTab.value;
  saveSettings(); applyTheme(settings.theme);
  renderCalendar(); activateTab(settings.startTab);
});
resetSettingsBtn.addEventListener('click', ()=>{
  settings = {...defaultSettings}; saveSettings();
  hydrateSettingsUI(); applyTheme(settings.theme);
  renderCalendar(); activateTab(settings.startTab);
});

// Boot
hydrateSettingsUI();
activateTab(settings.startTab || 'daily');
renderCalendar();

// ====== Export / Import / Clear
$('#exportBtn').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(db,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'plannerpro-backup.json'; a.click();
  URL.revokeObjectURL(url);
});
$('#importFile').addEventListener('change', (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(String(reader.result));
      if(obj){ db = Object.assign(structuredClone(blank), obj); save();
        renderNotes(); renderDaily(); renderMonthly(); renderYearly(); renderCalendar();
      }
    } catch(err){ alert('ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª'); }
    e.target.value='';
  };
  reader.readAsText(f);
});
$('#clearAll').addEventListener('click', ()=>{
  if(confirm('Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ')){
    db = structuredClone(blank); save();
    renderNotes(); renderDaily(); renderMonthly(); renderYearly(); renderCalendar();
  }
});
</script>
</body>
</html>
